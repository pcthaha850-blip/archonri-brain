name: Staging Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_count:
        description: 'Number of test runs'
        required: false
        default: '10'

env:
  NODE_VERSION: '20'

jobs:
  lint-and-test:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter (if configured)
        run: npm run lint --if-present
        continue-on-error: true

      - name: Run unit tests (if configured)
        run: npm test --if-present
        continue-on-error: true

  staging-harness:
    name: Staging Validation Harness
    runs-on: ubuntu-latest
    needs: lint-and-test
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run staging harness
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          HMAC_KEY: ${{ secrets.HMAC_KEY }}
          TASKS_DB_ID: ${{ secrets.TASKS_DB_ID }}
          DECISION_DB_ID: ${{ secrets.DECISION_DB_ID }}
          AGENT_OUTPUTS_DB_ID: ${{ secrets.AGENT_OUTPUTS_DB_ID }}
          ENTITIES_DB_ID: ${{ secrets.ENTITIES_DB_ID }}
          TEST_COUNT: ${{ github.event.inputs.test_count || '10' }}
        run: node staging/harness.js

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: staging-validation-results
          path: |
            staging/summary.json
            staging/results.jsonl
          retention-days: 30

      - name: Check gates passed
        run: |
          if [ -f staging/summary.json ]; then
            PASSED=$(jq -r '.passed' staging/summary.json)
            if [ "$PASSED" != "true" ]; then
              echo "❌ Staging gates failed!"
              jq '.gates' staging/summary.json
              exit 1
            fi
            echo "✅ All staging gates passed!"
          else
            echo "❌ summary.json not found!"
            exit 1
          fi

  promote-to-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: staging-harness
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    steps:
      - name: Await manual approval
        run: echo "Awaiting manual approval for production deployment..."

      - name: Deploy to production
        run: |
          echo "Production deployment would happen here"
          echo "Configure Railway CLI or other deployment tool"
          # railway up --service archonri-brain --environment production
